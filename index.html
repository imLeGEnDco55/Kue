<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Kue Studio</title>
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#111827">
    <style>
        :root {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color-scheme: dark;
            --bg: #05060a;
            --panel: #111827;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --text: #f3f4f6;
            --muted: #9ca3af;
            --danger: #ef4444;
            --card-bg: #1f2937;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- VISTAS --- */
        .view {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: var(--bg);
            transition: transform 0.3s ease, opacity 0.3s;
            z-index: 10;
        }

        .view.hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }

        /* Ajuste para cuando la home se oculta (se va a la izquierda) */
        .view.hidden-left {
            transform: translateX(-20%);
            opacity: 0;
            pointer-events: none;
        }

        /* --- HEADER COM√öN --- */
        header {
            padding: 12px 16px;
            background: var(--panel);
            border-bottom: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 800;
            background: linear-gradient(to right, #fff, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- HOME (DASHBOARD) --- */
        .project-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            align-content: start;
        }

        .project-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            aspect-ratio: 1 / 1;
            border: 1px solid #374151;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, border-color 0.2s;
        }

        .project-card:active {
            transform: scale(0.96);
        }

        .project-card:hover {
            border-color: var(--accent);
        }

        .p-title {
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1.2;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .p-date {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .p-count {
            font-size: 0.8rem;
            background: rgba(139, 92, 246, 0.1);
            color: #c4b5fd;
            padding: 2px 6px;
            border-radius: 4px;
            align-self: start;
            margin-top: auto;
        }

        .btn-fab {
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
        }

        .btn-fab:active {
            transform: scale(0.9);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--muted);
            padding-top: 40px;
        }

        /* --- EDITOR STYLES (Lo que ya ten√≠as) --- */
        .timeline-container {
            height: 100px;
            background: #0f172a;
            flex-shrink: 0;
            position: relative;
            border-bottom: 1px solid #1e293b;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .segments-scroller {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px;
        }

        .segment-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid #1f2937;
            align-items: center;
        }

        .segment-item.active {
            background: rgba(139, 92, 246, 0.15);
            border-left: 4px solid var(--accent);
            padding-left: 12px;
        }

        .time-badge {
            font-family: monospace;
            font-size: 0.9rem;
            color: #c4b5fd;
            background: rgba(139, 92, 246, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 55px;
            text-align: center;
        }

        .segment-note input {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1rem;
            padding: 4px 0;
            outline: none;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 1.2rem;
            padding: 8px;
        }

        .controls-area {
            background: rgba(11, 15, 25, 0.98);
            border-top: 1px solid #374151;
            padding: 12px 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 30;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            gap: 12px;
        }

        .main-btn {
            border: none;
            border-radius: 14px;
            font-weight: 700;
            font-size: 1rem;
            padding: 16px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }

        .main-btn:active:not(:disabled) {
            transform: scale(0.97);
        }

        .main-btn:disabled {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .btn-play {
            background: #334155;
        }

        .btn-mark {
            background: linear-gradient(135deg, #7c3aed, #db2777);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .btn-mark.recording {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            animation: pulse 2s infinite;
        }

        .back-btn {
            background: transparent;
            border: none;
            color: #e5e7eb;
            font-size: 1.2rem;
            padding: 8px;
            margin-right: 8px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.6);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(220, 38, 38, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
            }
        }

        /* Dialogo Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 320px;
            border: 1px solid #4b5563;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            margin-top: 16px;
        }

        .file-input-btn {
            width: 100%;
            background: var(--accent);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
        }

        .file-input-real {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="viewHome" class="view">
        <header>
            <h1>Kue Studio</h1>
        </header>

        <div class="project-list" id="projectList">
        </div>

        <button class="btn-fab" id="btnNewProject">+</button>
    </div>

    <div id="viewEditor" class="view hidden">
        <header>
            <div style="display:flex; align-items:center;">
                <button class="back-btn" id="btnBack">‚Üê</button>
                <div style="display: flex; flex-direction: column;">
                    <input type="text" id="projectTitleInput" value="Sin T√≠tulo"
                        style="background:transparent; border:none; color:white; font-weight:bold; font-size:1rem; outline:none; width: 200px;">
                </div>
            </div>
            <button id="btnSaveManual"
                style="background:transparent; border:none; color:var(--accent); font-size:1.2rem;">üíæ</button>
        </header>

        <div class="timeline-container">
            <canvas id="waveCanvas"></canvas>
        </div>

        <div class="segments-scroller" id="listContainer"></div>

        <div class="controls-area">
            <div
                style="display:flex; justify-content:space-between; font-size:0.8rem; color:#9ca3af; margin-bottom:4px;">
                <span id="fileNameDisplay">...</span>
                <span><span id="currTime">00:00</span> / <span id="totalTime">00:00</span></span>
            </div>

            <div class="action-grid">
                <button id="btnPlay" class="main-btn btn-play" disabled>‚ñ∂</button>
                <button id="btnMark" class="main-btn btn-mark" disabled>‚ö° MARK</button>
            </div>

            <div style="display:flex; gap:12px; margin-top:8px;">
                <button id="btnUndo"
                    style="background:transparent; border:1px solid #374151; color:#9ca3af; padding:8px 12px; border-radius:8px; flex:1;">‚Ü©
                    Deshacer</button>
                <button id="btnDeleteProject"
                    style="background:transparent; border:1px solid #ef4444; color:#ef4444; padding:8px 12px; border-radius:8px;">üóë
                    Borrar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newProjectModal">
        <div class="modal-card">
            <h2 style="margin-top:0;">Nuevo Proyecto</h2>
            <p style="color:var(--muted); font-size:0.9rem;">Ponle nombre y sube el audio para empezar.</p>
            <input type="text" id="newProjectName" placeholder="Nombre (ej. Ensayo 1)"
                style="width:100%; padding:10px; background:#111827; border:1px solid #374151; color:white; border-radius:8px; margin-bottom:12px;">

            <div class="file-input-wrapper">
                <button class="file-input-btn">üéµ Seleccionar Audio</button>
                <input type="file" id="newAudioFile" class="file-input-real" accept="audio/*">
            </div>

            <button id="btnCloseModal"
                style="margin-top:16px; background:transparent; border:none; color:var(--muted); width:100%;">Cancelar</button>
        </div>
    </div>

    <audio id="audioPlayer" style="display:none;"></audio>

    <script>
        // --- BASE DE DATOS (INDEXED DB) ---
        // Aqu√≠ ocurre la magia de guardar audios pesados
        const DB_NAME = 'KueStudioDB';
        const DB_VERSION = 1;
        let db;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains('projects')) {
                        // Creamos la "tabla" de proyectos. keyPath 'id' es la llave √∫nica
                        db.createObjectStore('projects', { keyPath: 'id' });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e);
            });
        };

        const dbOps = {
            async save(project) {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('projects', 'readwrite');
                    const store = tx.objectStore('projects');
                    store.put(project);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            async getAll() {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('projects', 'readonly');
                    const store = tx.objectStore('projects');
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            async get(id) {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('projects', 'readonly');
                    const store = tx.objectStore('projects');
                    const req = store.get(id);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            async delete(id) {
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('projects', 'readwrite');
                    const store = tx.objectStore('projects');
                    store.delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }
        };

        // --- ESTADO GLOBAL ---
        let currentProject = null; // { id, name, segments, audioBlob, createdAt }
        let recording = false;
        let lastCutTime = 0;
        let duration = 0;

        // --- REFERENCIAS UI ---
        const viewHome = document.getElementById('viewHome');
        const viewEditor = document.getElementById('viewEditor');
        const projectList = document.getElementById('projectList');
        const btnNewProject = document.getElementById('btnNewProject');
        const modal = document.getElementById('newProjectModal');
        const btnCloseModal = document.getElementById('btnCloseModal');
        const newAudioFile = document.getElementById('newAudioFile');
        const newProjectName = document.getElementById('newProjectName');

        // Editor UI
        const audio = document.getElementById('audioPlayer');
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const btnBack = document.getElementById('btnBack');
        const projectTitleInput = document.getElementById('projectTitleInput');
        const btnPlay = document.getElementById('btnPlay');
        const btnMark = document.getElementById('btnMark');
        const listContainer = document.getElementById('listContainer');
        const currTimeDisplay = document.getElementById('currTime');
        const totalTimeDisplay = document.getElementById('totalTime');
        const btnSaveManual = document.getElementById('btnSaveManual');
        const btnDeleteProject = document.getElementById('btnDeleteProject');
        const btnUndo = document.getElementById('btnUndo');

        // --- INICIO ---
        async function initApp() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            await initDB();
            loadHome();
            loop();
        }

        // --- NAVEGACI√ìN ---
        async function loadHome() {
            // Limpiar estado
            if (audio.src) {
                audio.pause();
                audio.src = "";
            }
            currentProject = null;

            // Mostrar Home
            viewHome.classList.remove('hidden-left');
            viewEditor.classList.add('hidden');

            // Renderizar lista
            projectList.innerHTML = '<div style="color:var(--muted);">Cargando...</div>';
            const projects = await dbOps.getAll();

            projectList.innerHTML = '';

            if (projects.length === 0) {
                projectList.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay rolas guardadas</h3>
                        <p>Dale al bot√≥n + para empezar.</p>
                    </div>
                `;
            } else {
                // Ordenar por fecha (m√°s nuevo primero)
                projects.sort((a, b) => b.createdAt - a.createdAt).forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    const date = new Date(p.createdAt).toLocaleDateString();
                    card.innerHTML = `
                        <div>
                            <div class="p-title">${p.name}</div>
                            <div class="p-date">${date}</div>
                        </div>
                        <div class="p-count">${p.segments.length} cortes</div>
                    `;
                    card.onclick = () => openProject(p.id);
                    projectList.appendChild(card);
                });
            }
        }

        async function openProject(id) {
            const p = await dbOps.get(id);
            if (!p) return;

            currentProject = p;

            // Cargar audio desde el Blob guardado
            const url = URL.createObjectURL(p.audioBlob);
            audio.src = url;

            projectTitleInput.value = p.name;
            document.getElementById('fileNameDisplay').textContent = "Cargado desde memoria";

            // Cambiar vista
            viewHome.classList.add('hidden-left');
            viewEditor.classList.remove('hidden');

            // Esperar metadata
            audio.onloadedmetadata = () => {
                duration = audio.duration;
                totalTimeDisplay.textContent = fmt(duration);
                renderSegments();
                updateControls();
            };
        }

        // --- NUEVO PROYECTO ---
        btnNewProject.onclick = () => {
            modal.classList.add('show');
            newProjectName.value = "";
            newAudioFile.value = "";
        };

        btnCloseModal.onclick = () => modal.classList.remove('show');

        newAudioFile.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const name = newProjectName.value || file.name.split('.')[0];
            const id = Date.now().toString(); // ID simple basado en tiempo

            const newProj = {
                id: id,
                name: name,
                createdAt: Date.now(),
                audioBlob: file, // ¬°Aqu√≠ guardamos el archivo f√≠sico!
                segments: []
            };

            // Guardar en DB
            await dbOps.save(newProj);
            modal.classList.remove('show');

            // Abrir de inmediato
            openProject(id);
        };

        // --- EDITOR LOGIC (Adaptada) ---
        btnBack.onclick = () => {
            saveCurrentState(); // Auto-save al salir
            loadHome();
        };

        btnSaveManual.onclick = () => {
            saveCurrentState();
            // Feedback visual r√°pido
            const original = btnSaveManual.textContent;
            btnSaveManual.textContent = "‚úÖ";
            setTimeout(() => btnSaveManual.textContent = original, 1000);
        };

        btnDeleteProject.onclick = async () => {
            if (confirm("¬øSeguro que quieres borrar este proyecto y su audio?")) {
                await dbOps.delete(currentProject.id);
                loadHome();
            }
        };

        projectTitleInput.oninput = (e) => {
            if (currentProject) currentProject.name = e.target.value;
        };

        async function saveCurrentState() {
            if (!currentProject) return;
            // Actualizamos en DB
            await dbOps.save(currentProject);
        }

        // --- PLAYBACK & MARKING (Igual que antes pero usando currentProject) ---
        btnPlay.onclick = () => {
            if (audio.paused) {
                audio.play();
                btnPlay.textContent = "‚è∏";
                btnPlay.style.background = "#475569";
            } else {
                audio.pause();
                btnPlay.textContent = "‚ñ∂";
                btnPlay.style.background = "";
            }
        };

        btnMark.onclick = () => {
            if (!currentProject) return;
            const now = audio.currentTime;

            if (navigator.vibrate) navigator.vibrate(40);

            if (!recording) {
                recording = true;
                lastCutTime = now;
                btnMark.textContent = "‚úÇ CORTAR";
                btnMark.classList.add('recording');
                if (audio.paused) btnPlay.click();
            } else {
                // Debounce simple
                if (now - lastCutTime < 0.5) return;
                cutSegment(now);
            }
        };

        function cutSegment(endTime) {
            const newSeg = {
                id: Date.now(),
                start: lastCutTime,
                end: endTime,
                note: ""
            };
            currentProject.segments.push(newSeg);
            lastCutTime = endTime;
            renderSegments();
            saveCurrentState(); // Auto-save en cada corte

            // Auto scroll
            setTimeout(() => {
                const el = document.getElementById(`seg-${newSeg.id}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // --- RENDER LISTA SEGMENTOS ---
        function renderSegments() {
            listContainer.innerHTML = "";
            if (!currentProject || currentProject.segments.length === 0) {
                listContainer.innerHTML = `<div style="padding:40px; text-align:center; color:#4b5563;">Dale play y marca.</div>`;
                return;
            }

            // Ordenar visualmente si fuera necesario, pero normalmente es cronol√≥gico
            currentProject.segments.forEach((s, idx) => {
                const el = document.createElement('div');
                el.className = 'segment-item';
                el.id = `seg-${s.id}`;
                el.innerHTML = `
                  <div class="time-badge" onclick="audio.currentTime=${s.start}">${fmt(s.start)}</div>
                  <div class="segment-note">
                    <input type="text" placeholder="Nota ${idx + 1}..." value="${s.note}" 
                           oninput="updateNote(${s.id}, this.value)">
                  </div>
                  <button class="delete-btn" onclick="deleteSeg(${s.id})">‚úï</button>
                `;
                listContainer.appendChild(el);
            });
        }

        // Helpers globales
        window.updateNote = (id, val) => {
            const s = currentProject.segments.find(x => x.id === id);
            if (s) { s.note = val; saveCurrentState(); } // Guardado silencioso
        };
        window.deleteSeg = (id) => {
            if (!confirm("¬øBorrar?")) return;
            currentProject.segments = currentProject.segments.filter(x => x.id !== id);
            renderSegments();
            saveCurrentState();
        };

        btnUndo.onclick = () => {
            if (currentProject && currentProject.segments.length > 0) {
                currentProject.segments.pop();
                renderSegments();
                saveCurrentState();
            }
        };

        // --- VISUALIZADOR ---
        function loop() {
            requestAnimationFrame(loop);
            if (!currentProject || !duration) return;

            // Draw Canvas
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            // Bloques guardados
            currentProject.segments.forEach(s => {
                const x = (s.start / duration) * w;
                const bw = ((s.end - s.start) / duration) * w;
                ctx.fillStyle = "rgba(139, 92, 246, 0.2)";
                ctx.fillRect(x, 0, bw, h);
                ctx.strokeStyle = "rgba(139, 92, 246, 0.4)";
                ctx.strokeRect(x, 0, bw, h);
            });

            // Bloque grabando
            if (recording) {
                const x = (lastCutTime / duration) * w;
                const bw = ((audio.currentTime - lastCutTime) / duration) * w;
                ctx.fillStyle = "rgba(239, 68, 68, 0.25)";
                ctx.fillRect(x, 0, bw, h);
            }

            // Playhead
            const px = (audio.currentTime / duration) * w;
            ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, h);
            ctx.lineWidth = 2; ctx.strokeStyle = "#f43f5e"; ctx.stroke();

            // Tiempo UI
            if (!audio.paused) currTimeDisplay.textContent = fmt(audio.currentTime);
        }

        // --- UTILS ---
        function resizeCanvas() {
            if (canvas.parentElement) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
        }
        function fmt(s) {
            if (!isFinite(s)) return "00:00";
            const m = Math.floor(s / 60);
            const sc = Math.floor(s % 60);
            return `${m}:${sc.toString().padStart(2, '0')}`;
        }
        function updateControls() {
            const hasAudio = duration > 0;
            btnPlay.disabled = !hasAudio;
            btnMark.disabled = !hasAudio;
        }

        // Arrancar
        initApp();

    </script>
</body>

</html>
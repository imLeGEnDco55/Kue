<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Kue Studio V7</title>
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#111827">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color-scheme: dark;
            --bg: #05060a;
            --panel: #111827;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --text: #f3f4f6;
            --muted: #9ca3af;
            --danger: #ef4444;
            --card-bg: #1f2937;
            --glass: rgba(17, 24, 39, 0.98);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- VISTAS --- */
        .view {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: var(--bg);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            z-index: 10;
        }

        .view.hidden {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }

        .view.hidden-left {
            transform: translateX(-30%);
            opacity: 0;
            pointer-events: none;
        }

        /* --- HEADER --- */
        header {
            padding: 8px 16px;
            background: var(--panel);
            border-bottom: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            flex-shrink: 0;
            z-index: 20;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(to right, #fff, #a78bfa);
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- HOME --- */
        .project-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            align-content: start;
        }

        .project-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            aspect-ratio: 1 / 1;
            border: 1px solid #374151;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .project-card:active {
            transform: scale(0.96);
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent);
            opacity: 0.7;
        }

        .p-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 6px;
            line-height: 1.3;
            color: #fff;
            overflow: hidden;
            display: -webkit-box;
            line-clamp: 2;
            box-orient: vertical;
        }

        .p-date {
            font-size: 0.75rem;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .p-count {
            font-size: 0.75rem;
            background: rgba(139, 92, 246, 0.15);
            color: #ddd6fe;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .btn-fab {
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #ec4899);
            color: white;
            border: none;
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s;
        }

        .btn-fab:active {
            transform: scale(0.9) rotate(90deg);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--muted);
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .empty-icon {
            font-size: 3rem;
            opacity: 0.5;
        }

        /* --- EDITOR --- */
        /* El Canvas ahora es m√°s prominente */
        .timeline-container {
            height: 140px;
            /* M√°s espacio visual */
            background: #0f172a;
            flex-shrink: 0;
            position: relative;
            border-bottom: 1px solid #1e293b;
            touch-action: none;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: crosshair;
        }

        .bpm-display {
            position: absolute;
            top: 8px;
            right: 8px;
            font-family: monospace;
            font-size: 0.75rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.6);
            color: #fbbf24;
            padding: 4px 8px;
            border-radius: 6px;
            pointer-events: none;
        }

        .wave-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            color: var(--accent);
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 12px;
            border-radius: 12px;
            pointer-events: none;
            display: none;
        }

        .wave-loading.show {
            display: block;
        }

        .segments-scroller {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 200px;
            scroll-behavior: smooth;
        }

        .segment-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            padding: 16px 16px;
            border-bottom: 1px solid #1f2937;
            align-items: center;
            transition: background 0.2s;
        }

        .segment-item.active {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid var(--accent);
            padding-left: 12px;
        }

        .time-badge {
            font-family: monospace;
            font-size: 0.9rem;
            color: #c4b5fd;
            background: rgba(139, 92, 246, 0.15);
            padding: 6px 10px;
            border-radius: 8px;
            min-width: 60px;
            text-align: center;
            font-weight: bold;
        }

        .segment-note input {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.05rem;
            padding: 4px 0;
            outline: none;
        }

        .segment-note input::placeholder {
            color: #4b5563;
            font-style: italic;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 1.3rem;
            padding: 10px;
            border-radius: 8px;
        }

        /* --- CONTROLES --- */
        .controls-area {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-top: 1px solid #374151;
            padding: 12px 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 30;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.6);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 2px;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 2.2fr;
            gap: 12px;
        }

        .main-btn {
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.1rem;
            padding: 18px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s, filter 0.2s;
            position: relative;
            overflow: hidden;
        }

        .main-btn:active:not(:disabled) {
            transform: scale(0.96);
        }

        .main-btn:disabled {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .btn-play {
            background: #334155;
            color: #f1f5f9;
        }

        .btn-mark {
            background: linear-gradient(135deg, #7c3aed, #db2777);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.3);
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        /* Bot√≥n cuando estamos grabando activo */
        .btn-mark.recording {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            animation: pulse 2s infinite;
        }

        /* Bot√≥n cuando estamos pausados pero en medio de un corte (CONTINUAR) */
        .btn-mark.resume {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            /* Ambar/Naranja */
        }

        .toolbar-row {
            display: flex;
            gap: 12px;
            margin-top: 4px;
        }

        .tool-btn {
            flex: 1;
            background: transparent;
            border: 1px solid #374151;
            color: #9ca3af;
            padding: 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tool-btn:active {
            background: #1f2937;
            color: #fff;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* --- MODALS --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 20px;
            width: 85%;
            max-width: 340px;
            border: 1px solid #4b5563;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            margin-top: 16px;
        }

        .file-input-btn {
            width: 100%;
            background: var(--accent);
            border: none;
            padding: 14px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .file-input-real {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 130px;
            /* Arriba de controles */
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #10b981;
            color: #064e3b;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .icon-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.3rem;
            padding: 8px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .icon-btn:hover {
            color: #fff;
        }
    </style>
</head>

<body>

    <!-- VISTA: HOME -->
    <div id="viewHome" class="view">
        <header>
            <h1>Kue Studio V7</h1>
        </header>

        <div class="project-list" id="projectList">
            <!-- JS inyecta aqu√≠ -->
        </div>

        <button class="btn-fab" id="btnNewProject">
            <span style="margin-top: -4px;">+</span>
        </button>
    </div>

    <!-- VISTA: EDITOR -->
    <div id="viewEditor" class="view hidden">
        <header>
            <div style="display:flex; align-items:center; gap: 4px;">
                <button id="btnBack" class="icon-btn">‚Üê</button>
                <input type="text" id="projectTitleInput" value="Sin T√≠tulo"
                    style="background:transparent; border:none; color:white; font-weight:800; font-size:1.1rem; outline:none; width: 160px;">
            </div>
            <div style="display:flex; gap:8px;">
                <button id="btnExportJSON" class="icon-btn" title="Exportar JSON">‚¨á</button>
            </div>
        </header>

        <!-- CANVAS INTERACTIVO (WAVEFORM) -->
        <div class="timeline-container">
            <canvas id="waveCanvas"></canvas>
            <div id="waveLoading" class="wave-loading">Cargando onda...</div>
            <div class="bpm-display" id="bpmDisplay">-- BPM</div>
        </div>

        <!-- LISTA DE CORTES -->
        <div class="segments-scroller" id="listContainer"></div>

        <!-- CONTROLES -->
        <div class="controls-area">
            <div class="info-row">
                <span id="fileNameDisplay"
                    style="max-width: 50%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; opacity:0.7;">...</span>
                <span style="font-family:monospace; font-weight:bold; color:#fff;">
                    <span id="currTime">00:00</span> / <span id="totalTime">00:00</span>
                </span>
            </div>

            <div class="action-grid">
                <button id="btnPlay" class="main-btn btn-play" disabled>
                    <span>‚ñ∂</span>
                </button>
                <button id="btnMark" class="main-btn btn-mark" disabled>
                    <span>‚ö° INICIAR</span>
                </button>
            </div>

            <div class="toolbar-row">
                <button id="btnUndo" class="tool-btn">‚Ü© Deshacer</button>
                <button id="btnDeleteProject" class="tool-btn"
                    style="color:#f87171; border-color:rgba(239,68,68,0.3);">üóë Borrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL CREAR -->
    <div class="modal" id="newProjectModal">
        <div class="modal-card">
            <h2 style="margin-top:0; font-size:1.3rem;">Nuevo Proyecto</h2>
            <input type="text" id="newProjectName" placeholder="Nombre (Ej. Clip Final)"
                style="width:100%; padding:14px; background:#111827; border:1px solid #374151; color:white; border-radius:12px; margin-bottom:12px; outline:none; font-size:1rem;">
            <div class="file-input-wrapper">
                <button class="file-input-btn">
                    <span>üéµ</span> Seleccionar Audio
                </button>
                <input type="file" id="newAudioFile" class="file-input-real" accept="audio/*">
            </div>
            <button id="btnCloseModal"
                style="margin-top:16px; background:transparent; border:none; color:#9ca3af; width:100%; padding:12px;">Cancelar</button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">¬°Guardado!</div>

    <audio id="audioPlayer" style="display:none;"></audio>

    <script>
        // --- BASE DE DATOS ---
        const DB_NAME = 'KueStudioDB';
        const DB_VERSION = 1;
        let db;

        const initDB = () => new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('projects')) db.createObjectStore('projects', { keyPath: 'id' });
            };
            req.onsuccess = (e) => { db = e.target.result; resolve(db); };
            req.onerror = (e) => reject(e);
        });

        const dbOps = {
            save: (p) => new Promise((res, rej) => {
                const tx = db.transaction('projects', 'readwrite');
                tx.objectStore('projects').put(p);
                tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error);
            }),
            getAll: () => new Promise((res, rej) => {
                const tx = db.transaction('projects', 'readonly');
                const req = tx.objectStore('projects').getAll();
                req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error);
            }),
            get: (id) => new Promise((res, rej) => {
                const tx = db.transaction('projects', 'readonly');
                const req = tx.objectStore('projects').get(id);
                req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error);
            }),
            delete: (id) => new Promise((res, rej) => {
                const tx = db.transaction('projects', 'readwrite');
                tx.objectStore('projects').delete(id);
                tx.oncomplete = () => res(); tx.onerror = () => rej(tx.error);
            })
        };

        // --- ESTADO ---
        let currentProject = null;
        let recording = false; // Indica si estamos en medio de un bloque ABIERTO
        let activeSegmentStart = null; // D√≥nde empez√≥ el bloque actual (si recording es true)
        let duration = 0;
        let activeSegmentId = null;

        // Waveform & Audio Context Vars
        let audioContext = null;
        let audioBuffer = null;
        let wavePeaks = [];

        // --- UI REFS ---
        const views = { home: document.getElementById('viewHome'), editor: document.getElementById('viewEditor') };
        const modals = { new: document.getElementById('newProjectModal') };
        const audio = document.getElementById('audioPlayer');
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const toast = document.getElementById('toast');
        const bpmLabel = document.getElementById('bpmDisplay');
        const waveLoader = document.getElementById('waveLoading');
        const btnPlay = document.getElementById('btnPlay');
        const btnMark = document.getElementById('btnMark');

        // --- INICIO ---
        async function initApp() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            await initDB();
            loadHome();
            loop();
        }

        // --- NAVEGACI√ìN ---
        async function loadHome() {
            if (audio.src) { audio.pause(); audio.src = ""; }
            currentProject = null; recording = false; activeSegmentStart = null;
            audioBuffer = null; wavePeaks = [];

            views.home.classList.remove('hidden-left');
            views.editor.classList.add('hidden');
            renderProjectList();
        }

        async function renderProjectList() {
            const list = document.getElementById('projectList');
            list.innerHTML = '<div style="color:var(--muted); text-align:center; padding:20px;">Cargando...</div>';
            const projects = await dbOps.getAll();
            list.innerHTML = '';

            if (projects.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üíø</div>
                        <div><h3 style="margin:0;">Sin rolas</h3><p style="font-size:0.9rem;">Dale al + para subir tu m√∫sica.</p></div>
                    </div>`;
            } else {
                projects.sort((a, b) => b.createdAt - a.createdAt).forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.innerHTML = `
                        <div><div class="p-title">${p.name}</div><div class="p-date">${new Date(p.createdAt).toLocaleDateString()}</div></div>
                        <div class="p-meta"><span class="p-count">${p.segments.length} cortes</span></div>`;
                    card.onclick = () => openProject(p.id);
                    list.appendChild(card);
                });
            }
        }

        async function openProject(id) {
            const p = await dbOps.get(id);
            if (!p) return;
            currentProject = p;
            audio.src = URL.createObjectURL(p.audioBlob);

            document.getElementById('projectTitleInput').value = p.name;
            document.getElementById('fileNameDisplay').textContent = p.audioBlob.name;

            // Resetear estado de grabaci√≥n al abrir
            recording = false;
            activeSegmentStart = null;
            updateMarkButtonUI();

            views.home.classList.add('hidden-left');
            views.editor.classList.remove('hidden');

            // Verificar si ya tenemos BPM guardado
            if (p.bpm) bpmLabel.textContent = p.bpm + " BPM";
            else bpmLabel.textContent = "-- BPM";

            audio.onloadedmetadata = () => {
                duration = audio.duration;
                document.getElementById('totalTime').textContent = fmt(duration);
                renderSegments();
                updateControls();
                analyzeAudio(p.audioBlob); // Disparar an√°lisis waveform
            };

            audio.onended = () => {
                btnPlay.innerHTML = "<span>‚ñ∂</span>";
                btnPlay.style.background = "";
                // Si estaba grabando, pausamos pero no cerramos (opcional), o cerramos.
                // El usuario pidi√≥ continuidad, as√≠ que mejor solo pausar UI.
            };
        }

        // --- AUDIO ANALYSIS ---
        async function analyzeAudio(blob) {
            try {
                waveLoader.classList.add('show');
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

                const arrayBuffer = await blob.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                generateWaveform(audioBuffer);

                if (!currentProject.bpm) {
                    const bpm = detectBPM(audioBuffer);
                    if (bpm > 0) {
                        currentProject.bpm = bpm;
                        bpmLabel.textContent = bpm + " BPM";
                        saveCurrentState();
                    }
                }
                waveLoader.classList.remove('show');
            } catch (e) { console.error(e); waveLoader.textContent = "Error"; }
        }

        function generateWaveform(buffer) {
            const channelData = buffer.getChannelData(0);
            const samples = 1200; // M√°s resoluci√≥n
            const step = Math.ceil(channelData.length / samples);
            wavePeaks = [];
            for (let i = 0; i < samples; i++) {
                let min = 1.0, max = -1.0;
                for (let j = 0; j < step; j++) {
                    const datum = channelData[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                wavePeaks.push({ min, max });
            }
        }

        function detectBPM(buffer) {
            // Detecci√≥n simple basada en picos de energ√≠a
            try {
                const data = buffer.getChannelData(0);
                const sampleRate = buffer.sampleRate;
                // Analizar un trozo de 10 segundos del medio
                const startSample = Math.floor(data.length / 2) - (sampleRate * 5);
                const endSample = startSample + (sampleRate * 10);
                const fragment = data.slice(Math.max(0, startSample), Math.min(data.length, endSample));

                let peaks = [];
                const threshold = 0.3;

                for (let i = 0; i < fragment.length; i++) {
                    if (fragment[i] > threshold) {
                        // Debounce simple de 0.2s
                        if (peaks.length === 0 || (i - peaks[peaks.length - 1]) > (sampleRate * 0.25)) {
                            peaks.push(i);
                        }
                    }
                }
                if (peaks.length < 2) return 0;

                // Calcular distancia promedio entre picos
                let totalDist = 0;
                for (let i = 0; i < peaks.length - 1; i++) {
                    totalDist += (peaks[i + 1] - peaks[i]);
                }
                const avgDist = totalDist / (peaks.length - 1);
                const bpm = Math.round(60 / (avgDist / sampleRate));

                // Ajustar a rango normal
                let finalBpm = bpm;
                while (finalBpm < 70) finalBpm *= 2;
                while (finalBpm > 170) finalBpm /= 2;

                return Math.round(finalBpm);
            } catch (e) { return 0; }
        }

        // --- LOGICA DE CORTE CORREGIDA ---

        // 1. Play/Pause
        btnPlay.onclick = () => {
            if (audio.paused) {
                audio.play();
                btnPlay.innerHTML = "<span>‚è∏</span>";
                btnPlay.style.background = "#475569";
            } else {
                audio.pause();
                btnPlay.innerHTML = "<span>‚ñ∂</span>";
                btnPlay.style.background = "";
            }
        };

        // 2. Mark Logic (The Core Fix)
        btnMark.onclick = () => {
            if (!currentProject) return;
            const now = audio.currentTime;
            if (navigator.vibrate) navigator.vibrate(40);

            // CASO A: NO ESTAMOS GRABANDO NADA -> ABRIR NUEVO BLOQUE
            if (!recording) {
                startSegment(now);
                if (audio.paused) btnPlay.click(); // Auto-play si est√° quieto
            }
            // CASO B: ESTAMOS GRABANDO -> CERRAR BLOQUE ACTUAL
            else {
                // Validar que no sea un micro-toque accidental (< 0.1s)
                if (now - activeSegmentStart < 0.1) return;

                finishSegment(now);
                // Inmediatamente abrimos el siguiente (Comportamiento "Cadena")
                // startSegment(now); // <-- SI QUIERES CORTES SEGUIDOS DESCOMENTA ESTO
                // PERO si prefieres Play/Stop estilo cl√°sico:
                startSegment(now); // Lo dejamos encadenado por defecto para videoclips
            }
        };

        function startSegment(startTime) {
            recording = true;
            activeSegmentStart = startTime;
            updateMarkButtonUI();
        }

        function finishSegment(endTime) {
            const newSeg = {
                id: Date.now(),
                start: activeSegmentStart,
                end: endTime,
                note: ""
            };

            // Aqu√≠ estaba el bug: antes revis√°bamos si "chocaba".
            // Ahora somos permisivos: simplemente lo agregamos y ordenamos despu√©s.
            currentProject.segments.push(newSeg);

            // Resetear inicio para el siguiente (encadenado)
            activeSegmentStart = endTime;

            renderSegments();
            saveCurrentState();

            // Scroll al nuevo item
            setTimeout(() => {
                const el = document.getElementById(`seg-${newSeg.id}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);
        }

        // Funci√≥n para actualizar la cara del bot√≥n Mark seg√∫n el estado
        function updateMarkButtonUI() {
            if (recording) {
                btnMark.innerHTML = "<span>‚úÇ CORTAR</span>";
                btnMark.className = "main-btn btn-mark recording";

                // Si pausamos el audio, cambiamos el bot√≥n a "CONTINUAR"
                if (audio.paused) {
                    btnMark.innerHTML = "<span>‚ñ∂ CONTINUAR</span>";
                    btnMark.className = "main-btn btn-mark resume";
                }
            } else {
                btnMark.innerHTML = "<span>‚ö° INICIAR</span>";
                btnMark.className = "main-btn btn-mark";
            }
        }

        // Escuchar pausa/play para actualizar el bot√≥n si estamos a medio corte
        audio.onpause = () => updateMarkButtonUI();
        audio.onplay = () => updateMarkButtonUI();

        // --- UTILIDADES UI ---
        document.getElementById('btnNewProject').onclick = () => modals.new.classList.add('show');
        document.getElementById('btnCloseModal').onclick = () => modals.new.classList.remove('show');

        document.getElementById('newAudioFile').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const name = document.getElementById('newProjectName').value.trim() || file.name.split('.')[0];
            const id = Date.now().toString();
            await dbOps.save({ id, name, createdAt: Date.now(), audioBlob: file, segments: [] });
            modals.new.classList.remove('show');
            openProject(id);
        };

        document.getElementById('btnBack').onclick = () => { saveCurrentState(); loadHome(); };
        document.getElementById('btnDeleteProject').onclick = async () => { if (confirm("¬øBorrar?")) { await dbOps.delete(currentProject.id); loadHome(); } };

        document.getElementById('btnExportJSON').onclick = () => {
            if (!currentProject) return;
            const data = {
                name: currentProject.name,
                bpm: currentProject.bpm || 0,
                source: currentProject.audioBlob.name,
                segments: currentProject.segments
            };
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
            a.download = `${currentProject.name}_kue.json`;
            a.click();
            showToastMsg("JSON listo");
        };

        document.getElementById('btnUndo').onclick = () => {
            if (currentProject?.segments.length > 0) {
                const rem = currentProject.segments.pop();
                // Si estamos grabando, regresamos el "inicio" del corte actual al inicio del que borramos
                if (recording) {
                    activeSegmentStart = rem.start;
                    audio.currentTime = rem.start; // Rebobinar para corregir
                }
                renderSegments(); saveCurrentState(); showToastMsg("Deshecho");
            }
        };

        async function saveCurrentState() { if (currentProject) await dbOps.save(currentProject); }
        function showToastMsg(msg) { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2000); }

        // RENDER LISTA
        const listContainer = document.getElementById('listContainer');
        function renderSegments() {
            listContainer.innerHTML = "";
            if (!currentProject || currentProject.segments.length === 0) {
                listContainer.innerHTML = `<div style="padding:40px; text-align:center; color:#4b5563;">A√∫n no hay cortes.</div>`;
                return;
            }
            // Ordenar cronol√≥gicamente para que la lista tenga sentido visual
            currentProject.segments.sort((a, b) => a.start - b.start);

            currentProject.segments.forEach((s, idx) => {
                const el = document.createElement('div');
                el.className = 'segment-item'; el.id = `seg-${s.id}`;
                el.innerHTML = `
                  <div class="time-badge" onclick="jumpTo(${s.start})">${fmt(s.start)}</div>
                  <div class="segment-note"><input type="text" placeholder="Corte ${idx + 1}..." value="${s.note}" onchange="updateNote(${s.id}, this.value)"></div>
                  <button class="delete-btn" onclick="deleteSeg(${s.id})">‚úï</button>`;
                listContainer.appendChild(el);
            });
        }

        window.jumpTo = (t) => { audio.currentTime = t; if (audio.paused) audio.play(); };
        window.updateNote = (id, v) => { const s = currentProject.segments.find(x => x.id === id); if (s) { s.note = v; saveCurrentState(); } };
        window.deleteSeg = (id) => { if (confirm("¬øBorrar?")) { currentProject.segments = currentProject.segments.filter(x => x.id !== id); renderSegments(); saveCurrentState(); } };

        // --- LOOP VISUAL (CANVAS) ---
        function loop() {
            requestAnimationFrame(loop);
            if (!currentProject || !duration) return;
            const w = canvas.width; const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            // 1. WAVEFORM
            if (wavePeaks.length > 0) {
                ctx.fillStyle = "rgba(139, 92, 246, 0.2)"; // Morado suave
                ctx.beginPath();
                const widthScale = w / wavePeaks.length;
                ctx.moveTo(0, h / 2);
                wavePeaks.forEach((p, i) => ctx.lineTo(i * widthScale, (h / 2) + (p.min * h / 2)));
                for (let i = wavePeaks.length - 1; i >= 0; i--) ctx.lineTo(i * widthScale, (h / 2) + (wavePeaks[i].max * h / 2));
                ctx.fill();
            }

            // 2. SEGMENTOS
            ctx.fillStyle = "rgba(139, 92, 246, 0.3)";
            currentProject.segments.forEach(s => {
                const x = (s.start / duration) * w; const bw = ((s.end - s.start) / duration) * w;
                ctx.fillRect(x, 0, bw, h);
                ctx.strokeStyle = "rgba(139, 92, 246, 0.8)"; ctx.strokeRect(x, 0, bw, h);
            });

            // 3. RECORDING GHOST SEGMENT
            if (recording && activeSegmentStart !== null) {
                const x = (activeSegmentStart / duration) * w;
                const bw = ((audio.currentTime - activeSegmentStart) / duration) * w;
                ctx.fillStyle = "rgba(239, 68, 68, 0.4)"; // Rojo
                ctx.fillRect(x, 0, bw, h);
                ctx.strokeStyle = "#ef4444"; ctx.strokeRect(x, 0, bw, h);
            }

            // 4. PLAYHEAD
            const px = (audio.currentTime / duration) * w;
            ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, h);
            ctx.lineWidth = 2; ctx.strokeStyle = "#f472b6"; ctx.stroke();

            // UI Updates
            if (!audio.paused) {
                document.getElementById('currTime').textContent = fmt(audio.currentTime);
                const active = currentProject.segments.find(s => audio.currentTime >= s.start && audio.currentTime < s.end);
                if (active && activeSegmentId !== active.id) {
                    activeSegmentId = active.id;
                    document.querySelectorAll('.segment-item').forEach(el => el.classList.remove('active'));
                    const el = document.getElementById(`seg-${active.id}`);
                    if (el) { el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                }
            }
        }

        canvas.addEventListener('pointerdown', (e) => {
            if (!duration) return;
            const rect = canvas.getBoundingClientRect();
            audio.currentTime = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)) * duration;
        });

        function resizeCanvas() { if (canvas.parentElement) { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; } }
        function fmt(s) { if (!isFinite(s)) return "00:00"; const m = Math.floor(s / 60), sc = Math.floor(s % 60); return `${m}:${sc.toString().padStart(2, '0')}`; }
        function updateControls() { const on = duration > 0; btnPlay.disabled = !on; btnMark.disabled = !on; }

        initApp();
    </script>
</body>

</html>